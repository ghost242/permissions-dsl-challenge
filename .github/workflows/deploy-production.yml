name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: production
      url: ${{ secrets.PROD_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Add uv to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv sync

      - name: Run all tests
        run: uv run pytest tests/ -v

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build production Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/permission-control:prod-${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/permission-control:prod-latest
            ${{ secrets.DOCKER_USERNAME }}/permission-control:${{ github.event.inputs.version }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/permission-control:prod-latest
          cache-to: type=inline

      - name: Run security scan on image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKER_USERNAME }}/permission-control:prod-${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Backup production database
        run: |
          echo "üîÑ Creating database backup..."
          # This is a placeholder - implement actual backup logic based on your setup
          # For managed databases, use their backup APIs
          # For self-hosted, use pg_dump or similar
          echo "‚úÖ Database backup created (placeholder)"

      - name: Deploy to production
        run: |
          echo "üöÄ Deploying to production..."
          # Placeholder for actual deployment
          # Implement based on your infrastructure:
          # - SSH to server and docker-compose pull/up
          # - Use cloud provider CLIs (AWS ECS, GCP Cloud Run, etc.)
          # - Use Kubernetes kubectl
          echo "‚úÖ Deployed to production (placeholder)"

      - name: Health check production
        run: |
          echo "üè• Performing health checks..."
          sleep 15

          # Health check with retries
          for i in {1..10}; do
            if curl -f ${{ secrets.PROD_URL }}/api/v1/health; then
              echo "‚úÖ Health check passed"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done

          echo "‚ùå Health check failed - initiating rollback"
          exit 1

      - name: Run production smoke tests
        run: |
          echo "üß™ Running smoke tests..."
          # Add critical path tests here
          curl -f ${{ secrets.PROD_URL }}/api/v1/health || exit 1
          echo "‚úÖ Smoke tests passed"

      - name: Monitor for errors
        run: |
          echo "üìä Monitoring deployment for 5 minutes..."
          sleep 300
          echo "‚úÖ Monitoring period complete"

      - name: Create GitHub release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.version }}
          release_name: Release ${{ github.event.inputs.version }}
          body: |
            Deployed to production

            **Changes:**
            - See commit history for details

            **Deployment Details:**
            - Commit: ${{ github.sha }}
            - Deployed by: ${{ github.actor }}
            - Deployment time: ${{ github.event.created_at }}
          draft: false
          prerelease: false

      - name: Notify deployment success
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          webhook-type: 'incoming-webhook'
          payload: |
            {
              "text": "üöÄ Production deployment successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment Successful*\n*Version:* ${{ github.event.inputs.version }}\n*Commit:* ${{ github.sha }}\n*Deployed by:* ${{ github.actor }}\n*URL:* ${{ secrets.PROD_URL }}"
                  }
                }
              ]
            }

      - name: Notify deployment failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          webhook-type: 'incoming-webhook'
          payload: |
            {
              "text": "‚ùå Production deployment failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment Failed*\n*Version:* ${{ github.event.inputs.version }}\n*Commit:* ${{ github.sha }}\n*Deployed by:* ${{ github.actor }}\n\n‚ö†Ô∏è Manual intervention may be required"
                  }
                }
              ]
            }
